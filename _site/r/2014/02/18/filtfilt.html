<!DOCTYPE HTML>
<html>
<head>
<link rel='stylesheet' type='text/css' href='/css/syntax.css' />
<link rel='stylesheet' type='text/css' href='/css/style.css' />
<meta charset="UTF-8">
<title>Improved filtfilt() for R</title>
</head>

<body>
<div class="navbar">
    <!-- <div class="navbar-inner"> -->
        <!-- <a class="brand" href="/index.html">Dan Kelley</a> -->
        <!-- <div class="nav">Dan Kelley</div> -->
        <ul class="navbar">
            
            <li><a href="/index.html">Dan Kelley</a></li>
            

            
            <li><a href="/publications.html">Publications</a></li>
            

            
            <li><a href="/textbook.html">Textbook</a></li>
            

            
            <li><a href="/software.html">Software</a></li>
            
            
            <li><a class="highlight" href="/blog">Blog</a></li>
            

        </ul>
        <!-- </div> -->
</div>

<div id="content">
    




<!-- <div class="span8"> -->

<div class=topnav>

<!-- | <a href='/blog'>Home</a> | -->

<a class="pagination" href="/2014/02/18/filtfilt.html" title="Filtfilt">
    <!-- &larr; --> Previous
</a>

</div> <!-- topnav -->


<div class="page-header">

<div class=post_title>Improved filtfilt() for R</div>
<!-- </div> --> <!-- span8 -->

<!-- <div class="span4"> -->

<div class=slug>
    <span class=post_date>
        Feb 18, 2014
    </span> <!-- post_date -->
    <span class=post_tags>
        
        <a href="/tags/R/index.html" class="tag">
            R
        </a>
         &#183; 
        
        <a href="/tags/time-series/index.html" class="tag">
            time-series
        </a>
        
        
    </span> <!-- post_date -->
    <div class=post_summary>
        A better filtfilt() for R.
    </div> <!-- post_summary -->
</div> <!-- slug ->

<!-- </div> -->
<!-- span4 -->
</div> <!-- page-header -->

Octave does as follows, which looks pretty simple.  Since Octave is GPL, it seems perfectly reasonable to build R code based on this.

# Octave implementation

<div class="highlight"><pre><code class="matlab">## <span class="n">Compute</span> <span class="n">a</span> <span class="n">the</span> <span class="n">initial</span> <span class="n">state</span> <span class="n">taking</span> <span class="n">inspiration</span> <span class="n">from</span>
## <span class="n">Likhterov</span> <span class="o">&amp;</span> <span class="n">Kopeika</span><span class="p">,</span> <span class="mf">2003.</span> &quot;<span class="n">Hardware</span><span class="o">-</span><span class="n">efficient</span> <span class="n">technique</span> <span class="k">for</span>
##     <span class="n">minimizing</span> <span class="n">startup</span> <span class="n">transients</span> <span class="n">in</span> <span class="n">Direct</span> <span class="n">Form</span> <span class="n">II</span> <span class="n">digital</span> <span class="n">filters</span>&quot;
<span class="n">kdc</span> <span class="p">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kdc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">inf</span><span class="p">)</span> # <span class="n">neither</span> <span class="n">NaN</span> <span class="n">nor</span> <span class="o">+/-</span> <span class="n">Inf</span>
  <span class="n">si</span> <span class="p">=</span> <span class="nb">fliplr</span><span class="p">(</span><span class="n">cumsum</span><span class="p">(</span><span class="nb">fliplr</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">kdc</span> <span class="o">*</span> <span class="n">a</span><span class="p">)));</span>
<span class="k">else</span>
  <span class="n">si</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">a</span><span class="p">));</span> # <span class="n">fall</span> <span class="n">back</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">initialization</span>
<span class="n">endif</span>
<span class="n">si</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="p">[];</span>

<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> # <span class="n">filter</span> <span class="n">all</span> <span class="n">columns</span><span class="p">,</span> <span class="n">one</span> <span class="n">by</span> <span class="n">one</span>
  <span class="n">v</span> <span class="p">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">c</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">((</span><span class="n">lrefl</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">c</span><span class="p">);</span> <span class="n">x</span><span class="p">(:,</span><span class="n">c</span><span class="p">);</span>
       <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">(</span><span class="k">end</span><span class="p">,</span><span class="n">c</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">((</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="k">end</span><span class="o">-</span><span class="n">lrefl</span><span class="p">,</span><span class="n">c</span><span class="p">)];</span> # <span class="n">a</span> <span class="n">column</span> <span class="n">vector</span>

  ## <span class="n">Do</span> <span class="n">forward</span> <span class="n">and</span> <span class="n">reverse</span> <span class="n">filtering</span>
  <span class="n">v</span> <span class="p">=</span> <span class="n">filter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">si</span><span class="o">*</span><span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>                   # <span class="n">forward</span> <span class="n">filter</span>
  <span class="n">v</span> <span class="p">=</span> <span class="nb">flipud</span><span class="p">(</span><span class="n">filter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="nb">flipud</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="n">si</span><span class="o">*</span><span class="n">v</span><span class="p">(</span><span class="k">end</span><span class="p">)));</span> # <span class="n">reverse</span> <span class="n">filter</span>
  <span class="n">y</span><span class="p">(:,</span><span class="n">c</span><span class="p">)</span> <span class="p">=</span> <span class="n">v</span><span class="p">((</span><span class="n">lrefl</span><span class="o">+</span><span class="mi">1</span><span class="p">):(</span><span class="n">lx</span><span class="o">+</span><span class="n">lrefl</span><span class="p">));</span>
<span class="n">endfor</span>
</code></pre></div>

## R implementation

```{r}
x <- rnorm(100) + sin((1:100)*2*pi/20)
ab <- signal::butter(2, 0.1)
a <- ab$a
b <- ab$b
kdc <- sum(b) / sum(a);
if (!is.nan(kdc)) {
  si <- rev(cumsum(rev(b - kdc * a)))
} else {
  si <- rep(0, length(a))
}
lx <- length(x)
si <- si[-1]
nx <- length(x)
n <- max(length(a), length(b))
lrefl <- 3 * (n - 1)
v <- cbind(c(2*x[1]-x[seq(lrefl+1,2,-1)]),
           x,
           c(2*x[nx]-x[seq(nx-1,nx-lrefl,-1)]))
v <- signal::filter(b,a,v,si*v[1])     # forward filter
v <- rev(signal::filter(b,a,rev(v),si*v[nx]))  # reverse filter
y <- v[seq.int(lrefl+1, lx+lrefl)]
t <- seq_along(x)
plot(t, x, type='l')
lines(t, y, col='red')
#
#  v = [2*x(1)-x((lrefl+1):-1:2); x(:);
#       2*x(end)-x((end-1):-1:end-lrefl)]; # a column vector
#
#  ## Do forward and reverse filtering
#  v = filter(b,a,v,si*v(1));                   # forward filter
#  v = flipud(filter(b,a,flipud(v),si*v(end))); # reverse filter
#  y(:) = v((lrefl+1):(lx+lrefl));
```



<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'dankelleydalhousie'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

<p class="footnote">This website is written in <a
href="http://jekyllrb.com">Jekyll</a>, and the source is available on <a
href="https://github.com/dankelley/dankelley.github.io">GitHub</a>.</p>

</body>
</html>

